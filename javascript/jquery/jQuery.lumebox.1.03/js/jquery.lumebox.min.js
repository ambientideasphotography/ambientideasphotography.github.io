/* Lumebox $ plugin
 * Copyright Anders Zakrisson/Sogeti 2009-2010
 * http://anders.zakrisson.se, http://www.sogeti.se
 * This software is released under the GPL License.
 */

(function(a){function i(){this.media=this.id=this.updated=this.description=this.link=this.title=null}function j(){this.version=this.description=this.link=this.title=null;this.items=[]}a.lumebox={settings:{showAsList:false,rss:[],proxy:"",duration:"fast",popupMaxWidth:680,opacity:"0.7",loop:true,scrollToTop:false,autoNext:false,infoText:"Use left and right arrow keys to jump to the other items, close with Esc or by clicking here.",parentElementId:false,useParentOffset:true,useGestures:true},data:{lumeboxItems:new j,
lumeboxFeeds:{},popupStatus:0,group:null,timeoutId:null,index:1},init:function(c){c?(a.lumebox.settings=a.extend({},a.lumebox.settings,c)):(c={});(this.settings.parentElementId?a("#"+this.settings.parentElementId):a("body").eq(0)).append('<div id="lumebox-popup"><div id="lumebox-content"></div><div id="lumebox-footer"></div></div><div id="lumebox-bg"></div>');a("#lumebox-footer").click(function(){a.lumebox.close()});a("#lumebox-bg").click(function(){a.lumebox.close()});this.settings.useGestures&&
a("#lumebox-popup").quickGestures({left:function(){a.lumebox.previous()},right:function(){a.lumebox.next()}});a(document).keydown(function(b){if(a.lumebox.data.popupStatus==1){switch(b.keyCode){case 27:a.lumebox.close();break;case 39:a.lumebox.next();break;case 78:a.lumebox.next();break;case 37:a.lumebox.previous();break;case 80:a.lumebox.previous();break}switch(b.charCode){case 110:a.lumebox.next();break;case 112:a.lumebox.previous();break}}});a(window).bind("resize",function(){a.lumebox.resize()});
var d;a("a[rel^=lightbox]").each(function(){var b=this.rel.match(/\[([a-zA-Z0-9\-]*)\]/i);if((b=b?b[1]:null)&&a.lumebox.data.lumeboxFeeds[b])d=a.lumebox.data.lumeboxFeeds[b];else if(b){d=new j;d.title=b;a.lumebox.data.lumeboxFeeds[b]=d}if(this.href.search(/(\.jpg|\.jpeg|\.gif|\.png)$/i)!=-1){var e,f=new i;f.description='<p><a href="'+this.href+'"><img src="'+this.href+'" class="lumebox-img" /></a></p><p>'+this.title+"</p>";f.link=this.href;f.id=this.href;e=b?a.lumebox.data.lumeboxFeeds[b].items.push(f)-
1:a.lumebox.data.lumeboxItems.items.push(f)-1;a(this).click(function(){a.lumebox.open({index:e,group:b});return false})}else this.rel.search(/lightbox\[(rss[a-zA-Z0-9\-]*)\]/i)!=-1&&a.lumebox.parseFeed({url:a.lumebox.settings.proxy+this.href,success:function(g){a.each(g.items,function(k,h){f=a.extend({},f,h);b?a.lumebox.data.lumeboxFeeds[b].items.push(f):a.lumebox.data.lumeboxItems.items.push(f)});a(this).click(function(){a.lumebox.open({index:null,group:b});return false})}})});a.each(a.lumebox.settings.rss,
function(b,e){a.lumebox.parseFeed({url:a.lumebox.settings.proxy+e,success:function(f){a.each(f.items,function(g,k){var h=a.extend({},h,k);a.lumebox.data.lumeboxItems.items.push(h)})}})});return this},resize:function(c){if(a.lumebox.data.popupStatus==1){var d=a(window).width(),b=a(window).height(),e=a.lumebox.settings.popupMaxWidth<d?a.lumebox.settings.popupMaxWidth:d,f=a("#lumebox-content").find("img.lumebox-img").attr("src")&&!a.lumebox.settings.showAsList?a("#lumebox-content").find("img.lumebox-img").outerWidth(true):
e;e=f>e?a.lumebox.settings.popupMaxWidth:f+a("#lumebox-content").css("padding-left").split("px")[0]*2;a("#lumebox-bg").css({height:b});a("#lumebox-popup").animate({width:e,left:d/2-e/2-(a.lumebox.settings.useParentOffset?a("body").offset().left:0)},a.lumebox.settings.duration,function(){var g=a("#lumebox-content").outerHeight(true)+a("#lumebox-footer").outerHeight(true);a(this).animate({height:g,top:a(window).scrollTop()+(g>b?0:b/2-g/2)},a.lumebox.settings.duration,function(){a.lumebox.settings.scrollToTop&&
a(this).scrollTop(0);a.isFunction(c)&&c()})})}},open:function(c){c||(c={});a.lumebox.data.group=c.group?c.group:null;var d=c.group?a.lumebox.data.lumeboxFeeds[c.group]:a.lumebox.data.lumeboxItems;a.lumebox.data.index=c.index?c.index:0;html="";if(a.lumebox.settings.showAsList){a.lumebox.data.index=0;a.each(d.items,function(b,e){html+=a.lumebox.createPostHtml(e)})}else html=a.lumebox.createPostHtml(d.items[a.lumebox.data.index]);a("#lumebox-content").html(html);if(a.lumebox.settings.infoText){c=a.lumebox.settings.showAsList?
"":a.lumebox.data.index+1+"/"+d.items.length+" ";a("#lumebox-footer").html(c+a.lumebox.settings.infoText)}if(a.lumebox.data.popupStatus==0){a("#lumebox-bg").css({opacity:a.lumebox.settings.opacity});a("#lumebox-bg").fadeIn(a.lumebox.settings.duration,function(){a("#lumebox-popup").children().css("opacity",0);a("#lumebox-popup").show();a.lumebox.resize(function(){a("#lumebox-popup").children().animate({opacity:1},a.lumebox.settings.duration)});if(a.lumebox.settings.autoNext&&!isNaN(a.lumebox.settings.autoNext)&&
!a.lumebox.settings.showAsList)a.lumebox.data.timeoutId=setInterval("$.lumebox.next()",a.lumebox.settings.autoNext)});a.lumebox.data.popupStatus=1}},close:function(){if(a.lumebox.data.popupStatus==1){a("#lumebox-bg").fadeOut(a.lumebox.settings.duration);a("#lumebox-popup").fadeOut(a.lumebox.settings.duration);a.lumebox.data.popupStatus=0}clearInterval(a.lumebox.data.timeoutId)},next:function(){var c=a.lumebox.data.group?a.lumebox.data.lumeboxFeeds[a.lumebox.data.group]:a.lumebox.data.lumeboxItems;
a.lumebox.data.index=a.lumebox.data.index<c.items.length-1?a.lumebox.data.index+1:0;a.lumebox._switchPost(c.items[a.lumebox.data.index],c)},previous:function(){var c=a.lumebox.data.group?a.lumebox.data.lumeboxFeeds[a.lumebox.data.group]:a.lumebox.data.lumeboxItems;a.lumebox.data.index=a.lumebox.data.index>0?a.lumebox.data.index-1:c.items.length-1;a.lumebox._switchPost(c.items[a.lumebox.data.index],c)},_switchPost:function(c,d){a.lumebox.data.popupStatus==1&&a("#lumebox-content > .post").length==1&&
a("#lumebox-content > .post").fadeOut(a.lumebox.settings.duration,function(){a("#lumebox-content").html(a.lumebox.createPostHtml(c)).css("opacity",0);if(a.lumebox.settings.infoText){var b=a.lumebox.settings.showAsList?"":a.lumebox.data.index+1+"/"+d.items.length+" ";a("#lumebox-footer").html(b+a.lumebox.settings.infoText)}a.lumebox.resize(function(){a("#lumebox-popup").children().animate({opacity:1},a.lumebox.settings.duration)})})},parseFeed:function(c){a.ajax({type:"GET",url:c.url,dataType:"xml",
success:function(d){var b=new j;if(a(d).find("rss").length){b.title=a(d).find("rss > channel > title").text();b.link=a(d).find("rss > channel > link").text();b.description=a(d).find("rss > channel > description").text();b.lastBuildDate=a(d).find("rss > channel > lastBuildDate").text();b.version=a(d).find("rss").attr("version");a(d).find("rss").attr("version")=="2.0"&&a(d).find("rss").attr("xmlns:media");a(d).find("rss > channel > item").each(function(){var e=new i;e.title=a(this).find("title").text();
e.link=a(this).find("link").text();e.updated=a(this).find("updated").text();e.id=a(this).find("guid").text();e.description=a(this).find("content\\:encoded").eq(0).text()?a(this).find("content\\:encoded").eq(0).text():a(this).find("description").text();b.items.push(e)})}else if(a(d).find("feed").attr("xmlns")=="http://www.w3.org/2005/Atom"){b.title=a(d).find("feed > title").text();b.link=a(d).find("feed > link").attr("href");b.description=a(d).find("feed > subtitle").text();b.lastBuildDate=a(d).find("feed > updated").text();
a(d).find("feed > entry").each(function(){var e=new i;e.title=a(this).find("title").eq(0).text();e.link=a(this).find("link").eq(0).text();e.updated=a(this).find("updated").eq(0).text();e.id=a(this).find("id").eq(0).text();e.description=a(this).find("content").eq(0).text()?a(this).find("content").eq(0).text():a(this).find("summary").eq(0).text();b.items.push(e)})}a.isFunction(c.success)&&c.success(b)},error:function(){return false}})},createPostHtml:function(c){var d="";if(c.title)d='<div class="post-title"><h2><a href="'+
c.link+'">'+c.title+"</a></h2></div>";return'<div class="post">'+d+'<div class="post-body>"><p>'+c.description+"</p></div></div>"}};a.fn.quickGestures=function(c){settings=a.extend({left:function(){},right:function(){},threshold:25},c);this.each(function(){var d={x:0,y:0};a(this).mousedown(function(b){d.x=b.pageX;d.y=b.pageY;a(this).mousemove(function(e){e=e.pageX-d.x;if(e<=-settings.threshold){a(this).unbind("mousemove");a.isFunction(settings.left)&&settings.left()}else if(e>=settings.threshold){a(this).unbind("mousemove");
a.isFunction(settings.right)&&settings.right()}})})});return this}})(jQuery);